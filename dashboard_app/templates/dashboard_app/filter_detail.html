{% extends "dashboard_app/_content.html" %}
{% load i18n %}
{% load django_tables2 %}

{% block extrahead %}
{{ block.super }}
<style type="text/css">
  table.select-compare1 td { cursor: pointer; }
  table.select-compare1 tr.even td {
    background-color: #ccf;
  }
  table.select-compare1 tr.even.hover td {
    background-color: #77f;
  }
  table.select-compare1 tr.odd td {
    background-color: #aaf;
  }
  table.select-compare1 tr.odd.hover td {
    background-color: #77f;
  }

  table.select-compare2 td { cursor: pointer; }
  table.select-compare2 tr.selected td { cursor: auto; }
  table.select-compare2 tr.even td {
    background-color: #fcc;
  }
  table.select-compare2 tr.odd td {
    background-color: #faa;
  }
  table.select-compare2 tr.selected td {
    background-color: #77f;
  }
  table.select-compare2 tr.selected.hover td {
    background-color: #77f;
  }
  table.select-compare2 tr.hover td {
    background-color: #f77;
  }
</style>
{% endblock %}

{% block content %}

<h1>[BETA] Filter {{ filter.name }}</h1>

{% include "dashboard_app/filter_summary.html" with filter_data=filter.as_data %}

{% if filter.owner == request.user %}
<p>
  You can <a href="{{ filter.get_absolute_url }}/+edit">edit</a>
  or <a href="{{ filter.get_absolute_url }}/+delete">delete</a> this filter.
</p>
{% endif %}

{% if subscription %}
<p>
  <a href="{% url dashboard_app.views.filters.views.filter_subscribe username=filter.owner.username name=filter.name %}">Manage</a> your subscription to this filter.
</p>
{% else %}
<p>
  <a href="{% url dashboard_app.views.filters.views.filter_subscribe username=filter.owner.username name=filter.name %}">Subscribe</a> to this filter.
</p>
{% endif %}

{% render_table filter_table %}

<p>
  <button id="compare-button">Compare builds</button>
  <span id="first-prompt" style="display:none">
    Click a build to compare.
  </span>
  <span id="second-prompt" style="display:none">
    Click build to compare with build <span id="the-build">XXX</span>.
  </span>
</p>


<script type="text/javascript">
var compareState = 0;
var compare1 = null;
$("#compare-button").button();
function cancelCompare () {
  $("#filter-table").removeClass("select-compare1");
  $("#filter-table").removeClass("select-compare2");
  $("#filter-table tr").removeClass("selected");
  $("#filter-table tr").unbind("click");
  $("#filter-table tr").unbind("hover");
  $("#first-prompt").hide()
  $("#second-prompt").hide()
  $("#compare-button").button({label:"Compare builds"});
  compareState = 0;
}
window.addEventListener('pagehide', cancelCompare, false);
$("#compare-button").click(
  function (e) {
    if (compareState == 0) {
      $(this).button({label:"Cancel"});
      $("#filter-table").addClass("select-compare1");
      $("#filter-table tr").click(rowClickHandler);
      $("#filter-table tr").hover(rowHoverHandlerIn, rowHoverHandlerOut);
      $("#first-prompt").show()
      compareState = 1;
    } else {
      cancelCompare();
    }
  }
);
function tagFromRow(tr) {
  var firstCell = $(tr).find("td:eq(0)");
  return {
   machinetag: firstCell.find("span").data("machinetag"),
   usertag: firstCell.text()
  }
}
function rowClickHandler() {
  if (compareState == 1) {
    compare1 = tagFromRow($(this));
    $(this).addClass("selected");
    $("#the-build").text(compare1.usertag);
    $("#first-prompt").hide();
    $("#second-prompt").show();
    $("#filter-table").removeClass("select-compare1");
    $("#filter-table").addClass("select-compare2");
    compareState = 2
  } else if (compareState == 2) {
    var compare2 = tagFromRow($(this)).machinetag;
    if (compare1.machinetag != compare2) {
      window.location += '/+compare/' + compare1.machinetag + '/' + tagFromRow($(this)).machinetag;
    }
  }
  tagFromRow(this);
}
function rowHoverHandlerIn() {
  $(this).addClass("hover");
}
function rowHoverHandlerOut() {
  $(this).removeClass("hover");
}
$("#filter-table").dataTable().fnSettings().fnRowCallback = function(tr, data, index) {
    if (compareState) {
      $(tr).click(rowClickHandler);
      $("#filter-table tr").hover(rowHoverHandlerIn, rowHoverHandlerOut);
      if (compareState == 2 && tagFromRow(tr).machinetag == compare1.machinetag) {
         $(tr).addClass("selected");
      }
    }
    return tr;
} ;
</script>

{% endblock %}
