{% extends "dashboard_app/_content_with_sidebar.html" %}
{% load i18n %}
{% load humanize %}

{% block extrahead %}
{{ block.super }}
<style type="text/css">
table {
    border-collapse: collapse;
}
td {
    border: thin solid grey;
    padding: 3px 4px;
    vertical-align: top;
}

</style>
{% endblock %}

{% block content %}
<h2>Result: {{ test_result.test_case|default:"<i>unknown test case</i>" }}</h2>
<table>
  <tr><td>{% trans "Test outcome" %}</td>
  <td>
    <img src="{{ STATIC_URL }}dashboard_app/images/icon-{{ test_result.result_code }}.png"
         alt="{{ test_result.get_result_display }}" width="16" height="16" border="0"/>
    {{ test_result.get_result_display }}
  </td></tr>
  <tr><td>{% trans "Measurement" %}</td>
  <td>
  {% if test_result.measurement != None %}
    {{ test_result.measurement|floatformat }} {{ test_result.test_case.units }}
  {% else %}
    <i>{% trans "no measurement taken" %}</i>
  {% endif %}
  </td></tr>
  <tr><td>{% trans "Log file location" %}</td>
  <td>
    {% if test_result.filename %}
        {% if test_result.related_attachment_available %}
        {% with test_result.related_attachment as attachment %}
        <a href="{{ attachment.get_absolute_url }}">{{ test_result.filename }}</a> line <a href="{{ attachment.get_absolute_url }}#L{{test_result.lineno}}">{{ test_result.lineno }}</a>
        {% endwith %}
        {% else %}
            {{ test_result.filename }} line {{ test_result.lineno }}
        {% endif %}
    {% else %}
        <i>{% trans "information not provided" %}</i>
    {% endif %}
  </td></tr>
  <tr><td>{% trans "Message from the log file" %}</td>
  <td>
  {% if test_result.message %}
    <code>{{ test_result.message|linebreaks }}</code>
  {% else %}
    <i>{% trans "information not provided" %}</i>
  {% endif %}
  </td></tr>
  <tr><td>{% trans "Test started on" %}</td>
  <td>
  {% if test_result.timestamp %}
    {{ test_result.timestamp|naturalday }}
    {{ test_result.timestamp|time }}
  {% else %}
    <i>{% trans "information not provided" %}</i>
  {% endif %}
  </td></tr>
  <tr><td>{% trans "Test duration" %}</td>
  <td>
  {% if test_result.duration %}
    {# TODO need a filter for displaying this sensibly. Currently there are some rounding errors #}
    {{ test_result.duration }}
  {% else %}
    <i>{% trans "information not provided" %}</i>
  {% endif %}
  </td></tr>
</table>

<h3>Attachments</h3>

{% if test_result.attachments.all %}
<ul class="attachments">
  {% for attachment in test_result.attachments.all %}
  <li>
    <b>{{ attachment }}</b> ({{attachment.mime_type}})
    {% if attachment.content %}
    ({{ attachment.content.size|filesizeformat }})
    {% endif %}
    <br />
    <a href="{{ attachment.get_absolute_url }}">download</a>
    {% if attachment.is_viewable %}
    &nbsp;<a href="{{ attachment.get_absolute_url }}">view</a>
    {% endif %}
  </li>
  {% endfor %}
</ul>
{% else %}
<i>none</i>
{% endif %}


{% if test_result.test_run.get_results.count > 1 %}
<h3>Other results from the same test run</h3>
<select id="other_results">
  {% regroup test_result.test_run.get_results by test_case as test_result_group_list %}
  {% for test_result_group in test_result_group_list %}
  {% if test_result_group.list|length > 1 %}<optgroup label="Results for test case {{ test_result_group.grouper }}">{% endif %}
    {% for other_test_result in test_result_group.list %}
    <option value="{{ other_test_result.get_absolute_url }}"
    {% if other_test_result.pk == test_result.pk %}disabled selected{% endif %}
    >
      Result #{{ other_test_result.relative_index }}: {{ other_test_result.get_result_display }}
      {% if test_result_group.list|length == 1 %} from test case {{ test_result_group.grouper }}{% endif %}
      {% if other_test_result.measurement != None %} ({{ other_test_result.measurement }}){% endif %}
    </option>
    {% endfor %}
  {% if test_result_group.list|length > 1 %}</optgroup>{% endif %}
  {% endfor %}
</select>
<script type="text/javascript">
  $("#other_results").change(function (event) {
    location.href=$(this).val();
  });
</script>
{% endif %}

{% endblock %}

{% block sidebar %}
<h3>Metadata</h3>
<dl>
  <dt>ID</dt>
  <dd>
    <small><span style="white-space:nowrap">{{ test_result.test_run.analyzer_assigned_uuid }}/{{ test_result.relative_index }}</span> (<a href="{{ test_result.get_permalink }}">{% trans "permalink" %}</a>)</small>
  </dd>
  <dt>Test Case</dt>
  <dd>
    {% if test_result.test_case %}
    <b>{{ test_result.test_case }}</b>
    {% else %}
    <i>{% trans "unknown test case" %}</i>
    {% endif %}
    {% trans "from test" %} <b><a href="{{ test_result.test_run.test.get_absolute_url }}">{{ test_result.test_run.test }}</a></b>
  </dd>
</dl>
<h3>Result Attributes</h3>
{% with test_result.attributes.values as attrs %}
<ul class="attributes">
  {% for item in attrs|dictsort:"name" %}
  <li>{{ item.name }}&nbsp;=&nbsp;{{ item.value }}</li>
  {% empty %}
  <i>none</i>
  {% endfor %}
</ul>
{% endwith %}
<h3>Run Attributes</h3>
{% with test_result.test_run.attributes.values as attrs %}
<ul class="attributes">
  {% for item in attrs|dictsort:"name" %}
  <li>{{ item.name }}&nbsp;=&nbsp;{{ item.value }}</li>
  {% empty %}
  <i>none</i>
  {% endfor %}
</ul>
{% endwith %}
{% endblock %}
