{% extends "lava_scheduler_app/_content.html" %}

{% load django_tables2 %}
{% block extrahead %}
{{ block.super }}
<style>
  details, summary { display: block; padding: 0.2em; }
  summary { cursor: pointer; }
  summary:hover, summary:focus { background: #ddd; }
  .no-details details > * { display: none; }
  .no-details details.open > * { display: block; }
  .no-details details summary:before { width: 20px; content: '► '; }
  .no-details details.open summary:before { content: '▼ '; }
  .no-details details summary { display: block; }
  .ui-button { width: 250px }
</style>
{% endblock %}


{% block content %}
{% block device_heading %}{% endblock %}

<table border=0 width="100%">
<colgroup>
<col width="15%">
<col width="20%">
<col width="20%">
<col width="20%">
</colgroup>
<tr>
<td style="vertical-align:text-top;text-align:left;">
    <dt>Hostname:</dt>
    <dd>{{ device.hostname }}</dd>

    <dt>Device type:</dt>
    <dd><a href="{{ device.device_type.get_absolute_url }}">{{ device.device_type }}</a></dd>

    <dt>Device version:</dt>
    <dd>{{ device.device_version|default:"Unknown" }}</dd>

    <dt>Device Tags</dt>
    {% for tag in device.tags.all %}
    <dd>{{ tag.name }}
    {% if tag.description %}
      <abbr title="{{ tag.description }}">(?)</abbr>
    {% endif %}
    </dd>
    {% empty %}
    <dd><i>None</i></dd>
    {% endfor %}

    <dt>Worker Hostname</dt>
    <dd>
    {% if device.too_long_since_last_heartbeat %}
      <img src="{{ STATIC_URL }}lava_scheduler_app/images/dut-offline-icon.png"/>
    {% else %}
      <img src="{{ STATIC_URL }}lava_scheduler_app/images/dut-available-icon.png"/>
    {% endif %}&nbsp;&nbsp;
    {% if device.worker_host.is_master %}
      <b><a href="{{ device.worker_host.get_absolute_url }}">{{ device.worker_host.hostname }}</a></b>
    {% else %}
      <a href="{{ device.worker_host.get_absolute_url }}">{{ device.worker_host.hostname }}</a>
    {% endif %}
    </dd>
</td>
<td style="vertical-align:text-top;text-align:left;">
    <dt>Device Owner:
        <abbr title="If specified, submissions to {{ device.hostname }} are restricted to this user or group.">(?)</abbr>
    </dt>
    <dd>
        {% if device.user %}
        <a href="mailto:{{ device.user.email }}">{{ device.user.email }}</a>
        {% elif device.group %}
        All users in the <b>{{ device.group }}</b> group.
        {% else %}
        Unrestricted
        {% endif %}
    </dd>
    {% if device.device_type.owners_only %}
        <dt>Hidden device type</dt>
        <dd>Only owners of one or more devices of type {{ device.device_type }}
        can see this information.</dd>
    {% endif %}
    <dt>User or group with physical access:
        <abbr title="If known, this is the user or group with physical access to {{ device.hostname }}.">(?)</abbr>
    </dt>
    <dd>
        {% if device.physical_owner %}
        <a href="mailto:{{ device.physical_owner.email }}">{{ device.physical_owner.email }}</a>
        {% elif device.physical_group %}
        <b>{{ device.physical_group }}</b> group.
        {% else %}
        Unknown
        {% endif %}
    </dd>
    <dt>Description:
        <abbr title="Device owners can edit this field">(?)</abbr>
    </dt>
    <dd>{{ device.get_description|truncatewords_html:200|wordwrap:80|linebreaksbr }}</dd>
</td>
<td style="vertical-align:text-top;text-align:left;">
    <dt>Status:</dt>
    <dd>
      {{ device.get_status_display }}
      {% if transition %}
      (reason: <i>{{ transition }}</i>)
      {% endif %}
    </dd>
    <dt>Health Status:</dt>
    <dd>
      {{ device.get_health_status_display }}
    </dd>
    {% if device.current_job %}
    <dt>Currently running:</dt>
    <dd><a href="{{ device.current_job.get_absolute_url }}"
      >Job {{ device.current_job }}</a></dd>
    {% endif %}
</td>
<td style="vertical-align:text-top;">
{% if show_maintenance %}
  <div class="maintenance-1">
        <button class="btn btn-block btn-primary" data-toggle="modal" data-target="#maintenance-dialog">Put into maintenance mode</button>
    <div class="modal fade" id="maintenance-dialog" tabindex="-1" role="dialog" aria-labelledby="MaintenanceModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="MaintenanceModelLabel">Reason for offlining</h4>
          </div>
          <div class="modal-body">
          <form role="form" method="post" action="{% url 'lava.scheduler.device.maintenance' device.pk %}">
          <div id="maintenance-container" class="form-group has-error has-feedback">
            <p>A reason must be specified:</p>
              <input id="maintenance-reason" name="reason"/>
              {% csrf_token %}
              <div id="maintenance-feedback">
              </div>
          </div>
            <dl class="dl-horizontal">
          {% if device.current_job %}
              <div class="form-group">
              <input type="checkbox" name="notify" value="{{user.email}}">Notify {{ user.email }} when job {{ device.current_job.id }} is complete.
              </div>
          {% endif %}
            <div class="form-group">
                <div id="maintenance-submit">
                </div>
                </div>
            </dl>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
<br/>
{% endif %}

{% if show_online %}
  <div class="online-1">
        <button class="btn btn-block btn-primary" data-toggle="modal" data-target="#online-dialog">Put online</button>
    <div class="modal fade" id="online-dialog" tabindex="-1" role="dialog" aria-labelledby="OnlineModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="OnlineModelLabel">Reason for onlining</h4>
          </div>
          <div class="modal-body">
          <form role="form" method="post" action="{% url 'lava.scheduler.device.online' device.pk %}">
          <div id="online-container" class="form-group has-error has-feedback">
            <p>A reason must be specified:</p>
              <input id="online-reason" name="reason"/>
              {% csrf_token %}
              <input type="checkbox" name="skiphealthcheck" value="True"/> Skip Health Check
              <div id="online-feedback">
              </div>
          </div>
            <dl class="dl-horizontal">
            <div class="form-group">
                <div id="online-submit">
                </div>
                </div>
            </dl>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
<br/>

  <div class="looping-1">
        <button class="btn btn-block btn-warning" data-toggle="modal" data-target="#looping-dialog">Put into looping mode</button>
    <div class="modal fade" id="looping-dialog" tabindex="-1" role="dialog" aria-labelledby="LoopingModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="LoopingModelLabel">Reason for looping health checks:</h4>
          </div>
          <div class="modal-body">
          <form role="form" method="post" action="{% url 'lava.scheduler.device.looping' device.pk %}">
          <div id="looping-container" class="form-group has-error has-feedback">
            <p>A reason must be specified:</p>
              <input id="looping-reason" name="reason"/>
              {% csrf_token %}
              <div id="looping-feedback">
              </div>
          </div>
            <dl class="dl-horizontal">
            <div class="form-group">
                <div id="looping-submit">
                </div>
                </div>
            </dl>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
<br/>
{% endif %}

{% if show_forcehealthcheck %}
<form role="form" method="POST"
      action="{% url 'lava.scheduler.device.forcehealthcheck' device.pk %}">
  {% csrf_token %}
  <button class="btn btn-block btn-info" id="forcehealthcheck-button">Force Health Check</button>
</form><br/>
{% endif %}

</td>
<td>
<p>&nbsp;&nbsp;</p>
</td>

<td style="vertical-align:text-top;text-align:left;">
{% if edit_description %}
  <div class="description-1">
        <button class="btn btn-block btn-default" data-toggle="modal" data-target="#description-dialog">Edit the device description</button>
    <div class="modal fade" id="description-dialog" tabindex="-1" role="dialog" aria-labelledby="DescriptionModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="DescriptionModelLabel">Edit the device description</h4>
          </div>
          <div class="modal-body">
          <form role="form" method="post" action="{% url 'lava.scheduler.device.edit_description' device.pk %}">
          <div id="description-container" class="form-group">
            <p>An empty description will clear the existing content</p>
              <input id="device-description" name="desc" value="{{ device.get_description }}"/>
              {% csrf_token %}
          </div>
            <dl class="dl-horizontal">
            <div class="form-group">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-success">Set</button>
                </div>
            </dl>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
<br/>
{% endif %}

{% if show_restrict %}
  <div class="restrict-1">
        <button class="btn btn-block btn-danger" data-toggle="modal" data-target="#restrict-dialog">Restrict submissions to {{ device.hostname }}</button>
    <div class="modal fade" id="restrict-dialog" tabindex="-1" role="dialog" aria-labelledby="RestrictModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="RestrictModelLabel">Reason for restricting {{ device.hostname }}</h4>
          </div>
          <div class="modal-body">
          <form role="form" method="post" action="{% url 'lava.scheduler.device.restrict_device' device.pk %}">
          <div id="restrict-container" class="form-group has-error has-feedback">
            <p>A reason must be specified:</p>
              <input id="restrict-reason" name="reason"/>
              {% csrf_token %}
              <div id="restrict-feedback">
              </div>
          </div>
            <dl class="dl-horizontal">
            <div class="form-group">
                <div id="restrict-submit">
                </div>
                </div>
            </dl>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
<br/>
{% endif %}

{% if show_pool %}
  <div class="derestrict-1">
        <button class="btn btn-block btn-danger" data-toggle="modal" data-target="#derestrict-dialog">Return {{ device.hostname }} to the pool</button>
    <div class="modal fade" id="derestrict-dialog" tabindex="-1" role="dialog" aria-labelledby="DerestrictModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="DerestrictModelLabel">Reason for returning {{ device.hostname }} to the pool</h4>
          </div>
          <div class="modal-body">
          <form role="form" method="post" action="{% url 'lava.scheduler.device.derestrict_device' device.pk %}">
          <div id="derestrict-container" class="form-group has-error has-feedback">
            <p>A reason must be specified:</p>
              <input id="derestrict-reason" name="reason"/>
              {% csrf_token %}
              <div id="derestrict-feedback">
              </div>
          </div>
            <dl class="dl-horizontal">
          {% if device.current_job %}
              <div class="form-group">
              <input type="checkbox" name="notify" value="{{user.email}}">Notify {{ user.email }} when job {{ device.current_job.id }} is complete.
              </div>
          {% endif %}
            <div class="form-group">
                <div id="derestrict-submit">
                </div>
                </div>
            </dl>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
<br/>
{% endif %}

</td>
</tr>
</table>
<br/>
{% block content_columns %}
{% endblock %}

<details>
  <summary>See status transitions</summary>
  {% render_table transition_table %}
</details>

<script type="text/javascript" src="{{ STATIC_URL }}lava_scheduler_app/js/jquery.details.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}lava_scheduler_app/js/jquery.jeditable.mini.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}lava-server//js/jquery-1.5.1.min.js"></script>
<script>
$(document).ready(
  function() {
{% if show_maintenance %}
    $("#maintenance-feedback").html('<span class="glyphicon glyphicon-remove form-control-feedback"></span>');
{% endif %}
{% if show_online %}
    $("#online-feedback").html('<span class="glyphicon glyphicon-remove form-control-feedback"></span>');
{% endif %}
{% if show_restrict %}
    $("#restrict-feedback").html('<span class="glyphicon glyphicon-remove form-control-feedback"></span>');
{% endif %}
{% if show_pool %}
    $("#derestrict-feedback").html('<span class="glyphicon glyphicon-remove form-control-feedback"></span>');
{% endif %}
  });
{% if show_maintenance %}
    $("#maintenance-container").keydown(
        function(e) {
                if (document.getElementById("maintenance-reason").value!=""){
                    $("#maintenance-feedback").html('<span class="glyphicon glyphicon-ok form-control-feedback"></span>')
                    $("#maintenance-submit").html('<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>' +
                            '<button type="submit" class="btn btn-primary">Put {{ device.hostname }} offline</button>');
                } else {
                    $("#maintenance-feedback").html('<span class="glyphicon glyphicon-remove form-control-feedback"></span>&nbsp;')
                    $("#maintenance-submit").html('<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>')
                }
          }
    )
{% endif %}
{% if show_online %}
    $("#online-container").keydown(
        function(e) {
                if (document.getElementById("online-reason").value!=""){
                    $("#online-feedback").html('<span class="glyphicon glyphicon-ok form-control-feedback"></span>')
                    $("#online-submit").html('<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>' +
                            '<button type="submit" class="btn btn-primary">Put {{ device.hostname }} online</button>');
                } else {
                    $("#online-feedback").html('<span class="glyphicon glyphicon-remove form-control-feedback"></span>&nbsp;')
                    $("#online-submit").html('<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>')
                }
          }
    )
    $("#looping-container").keydown(
        function(e) {
                if (document.getElementById("looping-reason").value!="") {
                    $("#looping-feedback").html('<span class="glyphicon glyphicon-ok form-control-feedback"></span>')
                    $("#looping-submit").html('<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>' +
                            '<button type="submit" class="btn btn-primary">Put {{ device.hostname }} into looping mode</button>');
                } else {
                    $("#looping-feedback").html('<span class="glyphicon glyphicon-remove form-control-feedback"></span>&nbsp;')
                    $("#looping-submit").html('<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>')
                }
        }
    )
{% endif %}
{% if show_restrict %}
    $("#restrict-container").keydown(
        function(e) {
                if (document.getElementById("restrict-reason").value!=""){
                    $("#restrict-feedback").html('<span class="glyphicon glyphicon-ok form-control-feedback"></span>')
                    $("#restrict-submit").html('<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>' +
                            '<button type="submit" class="btn btn-primary">Restrict {{ device.hostname }} </button>');
                } else {
                    $("#restrict-feedback").html('<span class="glyphicon glyphicon-remove form-control-feedback"></span>&nbsp;')
                    $("#restrict-submit").html('<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>')
                }
          }
    )
{% endif %}
{% if show_pool %}
    $("#derestrict-container").keydown(
        function(e) {
                if (document.getElementById("derestrict-reason").value!=""){
                    $("#derestrict-feedback").html('<span class="glyphicon glyphicon-ok form-control-feedback"></span>')
                    $("#derestrict-submit").html('<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>' +
                            '<button type="submit" class="btn btn-primary">Return {{ device.hostname }} to the pool</button>');
                } else {
                    $("#derestrict-feedback").html('<span class="glyphicon glyphicon-remove form-control-feedback"></span>&nbsp;')
                    $("#derestrict-submit").html('<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>')
                }
          }
    )
{% endif %}
</script>

{% endblock %}
